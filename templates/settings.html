<div class="settings-container">
    <h1>Settings</h1>

    <!-- LLM Settings -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>LLM Model Settings</h2>
            <div id="currentLLM" class="current-badge">-</div>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">Provider</label>
            <div class="provider-buttons" id="providerButtons">
                <button class="provider-btn" data-provider="openai" onclick="selectProvider('openai')">
                    <span class="provider-icon">O</span>
                    OpenAI
                </button>
                <button class="provider-btn" data-provider="ollama" onclick="selectProvider('ollama')">
                    <span class="provider-icon">L</span>
                    Ollama
                </button>
                <button class="provider-btn" data-provider="gemini" onclick="selectProvider('gemini')">
                    <span class="provider-icon">G</span>
                    Gemini
                </button>
            </div>
        </div>
        
        <div class="setting-group">
            <label class="setting-label">Model</label>
            <select id="modelSelect" class="model-select" onchange="onModelChange()">
                <option value="">Select Model...</option>
            </select>
            <div id="modelHint" class="setting-hint">Select provider first</div>
        </div>
        
        <div style="display: flex; gap: 12px; margin-top: 24px;">
            <button class="btn btn-primary" onclick="saveSettings()" id="saveBtn">
                Save Settings
            </button>
            <button class="btn btn-secondary" onclick="resetSettings()">
                Reset to Default
            </button>
        </div>
    </div>

    <!-- Embedding Settings (Read-only) -->
    <div class="card">
        <h2>Embedding Model</h2>
        <div class="setting-group">
            <label class="setting-label">Current Model</label>
            <div class="readonly-value" id="embeddingModel">-</div>
            <div class="setting-hint">
                Embedding model cannot be changed at runtime. Modify MODEL_KEY in .env to change.
            </div>
        </div>
    </div>

    <!-- Quick Info -->
    <div class="card info-card">
        <h3>Configuration Info</h3>
        <ul class="info-list">
            <li><strong>OpenAI</strong>: Requires OPENAI_API_KEY. Recommended for best performance.</li>
            <li><strong>Ollama</strong>: Local deployment. Requires Ollama server running.</li>
            <li><strong>Gemini</strong>: Requires GOOGLE_API_KEY. Google's LLM offering.</li>
        </ul>
        <p class="info-note">
            Settings are stored in memory. Restart will reset to .env defaults.
        </p>
    </div>
</div>

<style>
.settings-container {
    max-width: 800px;
    margin: 0 auto;
}

.setting-group {
    margin-bottom: 20px;
}

.setting-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 8px;
}

.setting-hint {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
}

.current-badge {
    background: rgba(59, 130, 246, 0.2);
    color: var(--primary);
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 500;
}

.provider-buttons {
    display: flex;
    gap: 12px;
}

.provider-btn {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    padding: 16px;
    background: var(--bg-dark);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.2s;
}

.provider-btn:hover {
    border-color: var(--primary);
    background: rgba(59, 130, 246, 0.05);
}

.provider-btn.active {
    border-color: var(--primary);
    background: rgba(59, 130, 246, 0.1);
    box-shadow: 0 0 0 1px var(--primary);
}

.provider-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bg-card-hover);
    border-radius: 10px;
    font-size: 18px;
    font-weight: 700;
}

.provider-btn.active .provider-icon {
    background: var(--primary);
    color: white;
}

.model-select {
    width: 100%;
    padding: 12px 16px;
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-main);
    font-size: 14px;
    cursor: pointer;
}

.model-select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

.readonly-value {
    padding: 12px 16px;
    background: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    color: var(--text-main);
    font-family: monospace;
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    font-size: 14px;
}

.btn-primary {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.btn-primary:hover {
    filter: brightness(1.1);
}

.btn-secondary {
    background: var(--bg-card-hover);
    color: var(--text-main);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-dark);
}

.info-card {
    background: rgba(59, 130, 246, 0.05);
    border-color: rgba(59, 130, 246, 0.2);
}

.info-card h3 {
    margin: 0 0 12px;
    font-size: 14px;
    color: var(--primary);
}

.info-list {
    margin: 0;
    padding-left: 20px;
    font-size: 13px;
    line-height: 1.8;
    color: var(--text-muted);
}

.info-list strong {
    color: var(--text-main);
}

.info-note {
    margin: 12px 0 0;
    padding-top: 12px;
    border-top: 1px solid var(--border-color);
    font-size: 12px;
    color: var(--warning);
}
</style>

<script>
let settings = null;
let selectedProvider = null;
let selectedModel = null;

async function loadSettings() {
    try {
        const res = await fetch('/settings');
        settings = await res.json();
        
        // Set current values
        selectedProvider = settings.llm.provider;
        selectedModel = settings.llm.model;
        
        // Update UI
        updateProviderButtons();
        updateModelSelect();
        updateCurrentBadge();
        
        // Embedding (read-only)
        const embeddingKey = settings.embedding.model_key;
        const embeddingDesc = settings.embedding.available_models[embeddingKey] || embeddingKey;
        document.getElementById('embeddingModel').textContent = embeddingDesc;
        
    } catch (e) {
        console.error('Failed to load settings:', e);
        showToast('Failed to load settings', 'error');
    }
    
    window.dispatchEvent(new Event("resize"));
}

function updateProviderButtons() {
    document.querySelectorAll('.provider-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.provider === selectedProvider);
    });
}

function updateModelSelect() {
    const select = document.getElementById('modelSelect');
    const hint = document.getElementById('modelHint');
    
    if (!selectedProvider || !settings) {
        select.innerHTML = '<option value="">Select provider first...</option>';
        hint.textContent = 'Select a provider to see available models';
        return;
    }
    
    const models = settings.llm.available_models[selectedProvider] || [];
    
    select.innerHTML = models.map(model => 
        `<option value="${model}" ${model === selectedModel ? 'selected' : ''}>${model}</option>`
    ).join('');
    
    // Add custom option
    if (selectedModel && !models.includes(selectedModel)) {
        select.innerHTML += `<option value="${selectedModel}" selected>${selectedModel} (custom)</option>`;
    }
    
    hint.textContent = `${models.length} models available for ${selectedProvider}`;
}

function updateCurrentBadge() {
    document.getElementById('currentLLM').textContent = `${selectedProvider} / ${selectedModel}`;
}

function selectProvider(provider) {
    selectedProvider = provider;
    
    // Set default model for provider
    if (settings && settings.llm.available_models[provider]) {
        const models = settings.llm.available_models[provider];
        // Keep current model if it exists in new provider, otherwise use first
        if (!models.includes(selectedModel)) {
            selectedModel = models[0];
        }
    }
    
    updateProviderButtons();
    updateModelSelect();
    updateCurrentBadge();
}

function onModelChange() {
    selectedModel = document.getElementById('modelSelect').value;
    updateCurrentBadge();
}

async function saveSettings() {
    if (!selectedProvider || !selectedModel) {
        showToast('Please select provider and model', 'warning');
        return;
    }
    
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';
    
    try {
        const res = await fetch('/settings/llm', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                provider: selectedProvider,
                model: selectedModel
            })
        });
        
        const data = await res.json();
        
        if (res.ok) {
            showToast('Settings saved successfully!');
            loadSettings(); // Reload to confirm
        } else {
            showToast(data.detail || 'Failed to save settings', 'error');
        }
        
    } catch (e) {
        console.error('Failed to save settings:', e);
        showToast('Failed to save settings', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Save Settings';
    }
}

async function resetSettings() {
    if (!confirm('Reset all settings to environment defaults?')) return;
    
    try {
        const res = await fetch('/settings/reset', { method: 'POST' });
        const data = await res.json();
        
        if (res.ok) {
            showToast('Settings reset to defaults');
            loadSettings();
        } else {
            showToast('Failed to reset settings', 'error');
        }
        
    } catch (e) {
        console.error('Failed to reset settings:', e);
        showToast('Failed to reset settings', 'error');
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? 'var(--error)' : type === 'warning' ? 'var(--warning)' : 'var(--success)'};
        color: white;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1001;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Load on init
loadSettings();
</script>
