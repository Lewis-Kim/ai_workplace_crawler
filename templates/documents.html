<div class="documents-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h1>ğŸ“ ë¬¸ì„œ ê´€ë¦¬</h1>
        <button class="btn btn-danger" onclick="deleteSelected()" id="deleteSelectedBtn" disabled>
            ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ (<span id="selectedCount">0</span>)
        </button>
    </div>

    <!-- í•„í„° ì˜ì—­ -->
    <div class="card" style="margin-bottom: 20px;">
        <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
            <select id="folderFilter" onchange="loadDocuments()" style="min-width: 150px;">
                <option value="">ì „ì²´ í´ë”</option>
            </select>
            <select id="fileTypeFilter" onchange="loadDocuments()" style="min-width: 120px;">
                <option value="">ì „ì²´ íƒ€ì…</option>
                <option value="pdf">PDF</option>
                <option value="docx">DOCX</option>
                <option value="xlsx">Excel</option>
                <option value="txt">TXT</option>
                <option value="csv">CSV</option>
            </select>
            <button class="btn btn-secondary" onclick="loadDocuments()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            <span id="docCount" style="margin-left: auto; color: var(--text-muted); font-size: 14px;"></span>
        </div>
    </div>

    <!-- ë¬¸ì„œ í…Œì´ë¸” -->
    <div class="card table-card">
        <table class="doc-table" id="docTable">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    <th style="width: 60px;">ID</th>
                    <th>ì œëª©</th>
                    <th style="width: 80px;">íƒ€ì…</th>
                    <th style="width: 150px;">í´ë”</th>
                    <th style="width: 80px;">ì²­í¬</th>
                    <th style="width: 80px;">ì´ë¯¸ì§€</th>
                    <th style="width: 100px;">ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="docTableBody">
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                        ë¡œë”© ì¤‘...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
<div id="deleteModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>âš ï¸ ì‚­ì œ í™•ì¸</h3>
        <p id="deleteMessage">ì„ íƒí•œ ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="font-size: 13px; color: var(--warning);">
            * MySQL ë°ì´í„°ì™€ Qdrant ë²¡í„°ê°€ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.
        </p>
        <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-danger" onclick="confirmDelete()">ì‚­ì œ</button>
        </div>
    </div>
</div>

<style>
.documents-container {
    max-width: 1200px;
    margin: 0 auto;
}

.table-card {
    padding: 0;
    overflow: hidden;
}

.doc-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

.doc-table th,
.doc-table td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

.doc-table th {
    background: var(--bg-card-hover);
    font-weight: 600;
    font-size: 13px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.doc-table tbody tr:hover {
    background: rgba(59, 130, 246, 0.05);
}

.doc-table tbody tr.selected {
    background: rgba(59, 130, 246, 0.1);
}

.file-icon {
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-pdf { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
.badge-docx { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
.badge-xlsx { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
.badge-txt { background: rgba(148, 163, 184, 0.2); color: #94a3b8; }
.badge-csv { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }

.btn-danger {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.btn-danger:hover {
    filter: brightness(1.1);
}

.btn-danger:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: var(--bg-card-hover);
    color: var(--text-main);
    border: 1px solid var(--border-color);
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.btn-icon {
    padding: 6px 10px;
    border-radius: 6px;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 24px;
    min-width: 400px;
    max-width: 500px;
}

.modal-content h3 {
    margin: 0 0 16px;
}

/* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
    accent-color: var(--primary);
}
</style>

<script>
let documents = [];
let selectedIds = new Set();
let pendingDeleteIds = [];

async function loadDocuments() {
    const folderFilter = document.getElementById('folderFilter').value;
    const fileTypeFilter = document.getElementById('fileTypeFilter').value;
    
    let url = '/documents?limit=500';
    if (folderFilter) url += `&folder_name=${encodeURIComponent(folderFilter)}`;
    if (fileTypeFilter) url += `&file_type=${encodeURIComponent(fileTypeFilter)}`;
    
    try {
        const res = await fetch(url);
        documents = await res.json();
        
        renderTable();
        updateFolderFilter();
        document.getElementById('docCount').textContent = `ì´ ${documents.length}ê°œ ë¬¸ì„œ`;
    } catch (e) {
        console.error('Failed to load documents:', e);
        document.getElementById('docTableBody').innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: var(--error);">
                    ë¬¸ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
                </td>
            </tr>
        `;
    }
    
    window.dispatchEvent(new Event("resize"));
}

function renderTable() {
    const tbody = document.getElementById('docTableBody');
    
    if (documents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-muted);">
                    ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = documents.map(doc => `
        <tr class="${selectedIds.has(doc.seq_id) ? 'selected' : ''}" data-id="${doc.seq_id}">
            <td>
                <input type="checkbox" 
                       ${selectedIds.has(doc.seq_id) ? 'checked' : ''} 
                       onchange="toggleSelect(${doc.seq_id})">
            </td>
            <td style="font-family: monospace; color: var(--text-muted);">${doc.seq_id}</td>
            <td>
                <div class="file-icon">
                    ${getFileIcon(doc.file_type)}
                    <span style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; display: inline-block;">
                        ${doc.title || '(ì œëª© ì—†ìŒ)'}
                    </span>
                </div>
            </td>
            <td><span class="badge badge-${doc.file_type}">${(doc.file_type || 'unknown').toUpperCase()}</span></td>
            <td style="color: var(--text-muted); font-size: 13px;">${doc.folder_name || '-'}</td>
            <td style="text-align: center;">${doc.chunk_count}</td>
            <td style="text-align: center;">${doc.image_count}</td>
            <td>
                <button class="btn btn-danger btn-icon btn-sm" onclick="deleteSingle(${doc.seq_id})" title="ì‚­ì œ">
                    ğŸ—‘ï¸
                </button>
            </td>
        </tr>
    `).join('');
}

function updateFolderFilter() {
    const select = document.getElementById('folderFilter');
    const currentValue = select.value;
    
    const folders = [...new Set(documents.map(d => d.folder_name).filter(Boolean))];
    
    // ê¸°ì¡´ ì˜µì…˜ ìœ ì§€í•˜ë©´ì„œ ì—…ë°ì´íŠ¸
    const existingFolders = new Set([...select.options].slice(1).map(o => o.value));
    
    folders.forEach(folder => {
        if (!existingFolders.has(folder)) {
            const option = document.createElement('option');
            option.value = folder;
            option.textContent = folder;
            select.appendChild(option);
        }
    });
    
    select.value = currentValue;
}

function getFileIcon(fileType) {
    const icons = {
        'pdf': 'ğŸ“•',
        'docx': 'ğŸ“˜',
        'doc': 'ğŸ“˜',
        'txt': 'ğŸ“„',
        'xlsx': 'ğŸ“Š',
        'xls': 'ğŸ“Š',
        'csv': 'ğŸ“Š',
        'jpg': 'ğŸ–¼ï¸',
        'jpeg': 'ğŸ–¼ï¸',
        'png': 'ğŸ–¼ï¸'
    };
    return icons[fileType?.toLowerCase()] || 'ğŸ“';
}

function toggleSelect(id) {
    if (selectedIds.has(id)) {
        selectedIds.delete(id);
    } else {
        selectedIds.add(id);
    }
    updateSelectedUI();
    renderTable();
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    
    if (selectAll.checked) {
        documents.forEach(doc => selectedIds.add(doc.seq_id));
    } else {
        selectedIds.clear();
    }
    
    updateSelectedUI();
    renderTable();
}

function updateSelectedUI() {
    const count = selectedIds.size;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('deleteSelectedBtn').disabled = count === 0;
    document.getElementById('selectAll').checked = count === documents.length && count > 0;
}

function deleteSingle(id) {
    const doc = documents.find(d => d.seq_id === id);
    pendingDeleteIds = [id];
    document.getElementById('deleteMessage').innerHTML = `
        <b>"${doc?.title || 'ë¬¸ì„œ ' + id}"</b>ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>
        <span style="font-size: 13px; color: var(--text-muted);">ì²­í¬ ${doc?.chunk_count || 0}ê°œ, ì´ë¯¸ì§€ ${doc?.image_count || 0}ê°œ</span>
    `;
    document.getElementById('deleteModal').style.display = 'flex';
}

function deleteSelected() {
    if (selectedIds.size === 0) return;
    
    pendingDeleteIds = [...selectedIds];
    document.getElementById('deleteMessage').innerHTML = `
        ì„ íƒí•œ <b>${pendingDeleteIds.length}ê°œ</b> ë¬¸ì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
    `;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('deleteModal').style.display = 'none';
    pendingDeleteIds = [];
}

async function confirmDelete() {
    if (pendingDeleteIds.length === 0) return;
    
    closeModal();
    
    try {
        if (pendingDeleteIds.length === 1) {
            // ë‹¨ì¼ ì‚­ì œ
            const res = await fetch(`/documents/${pendingDeleteIds[0]}`, { method: 'DELETE' });
            const data = await res.json();
            
            if (data.success) {
                showToast(`ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ (ë²¡í„° ${data.deleted_vectors}ê°œ ì‚­ì œ)`);
            } else {
                showToast('ì‚­ì œ ì‹¤íŒ¨: ' + data.message, 'error');
            }
        } else {
            // ì¼ê´„ ì‚­ì œ
            const res = await fetch('/documents/batch-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ doc_ids: pendingDeleteIds })
            });
            const data = await res.json();
            
            if (data.success) {
                showToast(`${data.total_deleted}ê°œ ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ`);
            } else {
                showToast(`${data.total_deleted}ê°œ ì‚­ì œ, ${data.failed.length}ê°œ ì‹¤íŒ¨`, 'warning');
            }
        }
        
        // ì„ íƒ ì´ˆê¸°í™” ë° ìƒˆë¡œê³ ì¹¨
        selectedIds.clear();
        pendingDeleteIds = [];
        updateSelectedUI();
        loadDocuments();
        
    } catch (e) {
        console.error('Delete failed:', e);
        showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${type === 'error' ? 'var(--error)' : type === 'warning' ? 'var(--warning)' : 'var(--success)'};
        color: white;
        border-radius: 8px;
        font-size: 14px;
        z-index: 1001;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ì´ˆê¸° ë¡œë“œ
loadDocuments();
</script>

<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>
