<div class="dashboard">

  <h1>ğŸ“Š ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ</h1>

  <!-- KPI Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">ì´ ë¬¸ì„œ ìˆ˜</div>
      <div class="stat-value" id="totalDocs">-</div>
    </div>
    <div class="stat-card success">
      <div class="stat-label">ì •ìƒ ì²˜ë¦¬</div>
      <div class="stat-value" id="successDocs">-</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-label">ì¤‘ë³µ íŒŒì¼</div>
      <div class="stat-value" id="dupDocs">-</div>
    </div>
    <div class="stat-card error">
      <div class="stat-label">ì—ëŸ¬ ë°œìƒ</div>
      <div class="stat-value" id="errorDocs">-</div>
    </div>
  </div>

  <!-- System Status -->
  <div class="card">
    <h2>âš™ ì‹œìŠ¤í…œ ìƒíƒœ</h2>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 8px #22c55e;"></div>
            <span>Ingest Service</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 8px; height: 8px; border-radius: 50%; background: #22c55e; box-shadow: 0 0 8px #22c55e;"></div>
            <span>Vector DB (Qdrant)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <span style="opacity: 0.7;">ëª¨ë¸:</span>
            <b>openai / ollama</b>
        </div>
    </div>
  </div>

  <!-- Recent Logs -->
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h2>ğŸ“œ ì‹¤ì‹œê°„ ë¡œê·¸</h2>
        <span style="font-size: 12px; color: var(--text-muted); display: flex; align-items: center; gap: 4px;">
            <span style="display: block; width: 6px; height: 6px; background: #ef4444; border-radius: 50%; animation: blink 1s infinite;"></span>
            Live
        </span>
    </div>
    <div class="log-container" id="logBox">
        loading...
    </div>
  </div>

</div>

<style>
@keyframes blink {
    0% { opacity: 1; }
    50% { opacity: 0.4; }
    100% { opacity: 1; }
}
</style>

<script>
async function loadDashboard() {
  try {
    const res = await fetch("/api/dashboard/summary");
    const data = await res.json();

    document.getElementById("totalDocs").textContent = data.total;
    document.getElementById("successDocs").textContent = data.success;
    document.getElementById("dupDocs").textContent = data.duplicated;
    document.getElementById("errorDocs").textContent = data.error;
  } catch (e) {
    console.error(e);
  }
}

async function loadLogs() {
  try {
    const res = await fetch("/api/logs?limit=50");
    const data = await res.json();

    const box = document.getElementById("logBox");
    box.innerHTML = data.logs.map(line => {
        let className = "log-entry";
        if (line.includes("[ERROR]")) className += " error";
        else if (line.includes("[INFO]")) className += " info";
        else if (line.includes("[SUCCESS]")) className += " success";
        
        return `<div class="${className}">${line}</div>`;
    }).join("");
    
    // Auto scroll to bottom
    // box.scrollTop = box.scrollHeight; // Optional: depends on user preference
  } catch(e) { console.error(e); }

  // iframe ë†’ì´ ìë™ ì¬ì¡°ì • íŠ¸ë¦¬ê±°
  window.dispatchEvent(new Event("resize"));
}

loadDashboard();
loadLogs();
setInterval(loadLogs, 3000);
</script>
