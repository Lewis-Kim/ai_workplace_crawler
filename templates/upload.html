<div style="max-width: 800px; margin: 0 auto;">
    <h1>ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</h1>
    <p style="color: var(--text-muted); margin-bottom: 32px;">ë¬¸ì„œ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ RAG ì‹œìŠ¤í…œì— ë“±ë¡í•˜ì„¸ìš”.</p>

    <div class="dropzone" id="dropzone">
        <div class="dropzone-icon">ğŸ“‚</div>
        <div class="dropzone-text">
            <strong>íŒŒì¼ ì„ íƒ</strong> ë˜ëŠ” ì—¬ê¸°ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”<br>
            <span style="font-size: 12px; opacity: 0.7; margin-top: 8px; display: block;">ì§€ì› í˜•ì‹: PDF, TXT, MD, DOCX</span>
        </div>
    </div>

    <div class="status" id="status" style="margin-top: 24px;"></div>

    <div class="card" style="margin-top: 40px;">
        <h2>ğŸ“œ ì²˜ë¦¬ ë¡œê·¸</h2>
        <div class="log-container" id="logBox" style="height: 200px;">loading...</div>
    </div>
</div>

<script>
const dropzone = document.getElementById("dropzone");
const statusBox = document.getElementById("status");

["dragenter", "dragover"].forEach(evt => {
  dropzone.addEventListener(evt, e => {
    e.preventDefault();
    dropzone.classList.add("dragover");
  });
});

["dragleave", "drop"].forEach(evt => {
  dropzone.addEventListener(evt, e => {
    e.preventDefault();
    dropzone.classList.remove("dragover");
  });
});

dropzone.addEventListener("drop", async (e) => {
  const items = e.dataTransfer.items;
  if (!items) return;

  const files = [];

  async function traverse(entry, path = "") {
    if (entry.isFile) {
      await new Promise(resolve => {
        entry.file(file => {
          file.relativePath = path + file.name;
          files.push(file);
          resolve();
        });
      });
    } else if (entry.isDirectory) {
      const reader = entry.createReader();
      await new Promise(resolve => {
        reader.readEntries(async entries => {
          for (const ent of entries) {
            await traverse(ent, path + entry.name + "/");
          }
          resolve();
        });
      });
    }
  }

  for (const item of items) {
    const entry = item.webkitGetAsEntry();
    if (entry) await traverse(entry);
  }

  if (files.length === 0) {
    alert("ì—…ë¡œë“œí•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  statusBox.innerHTML = `
    <div style="background: var(--bg-card-hover); padding: 16px; border-radius: 8px; border: 1px solid var(--primary);">
        <div style="display: flex; align-items: center; gap: 12px;">
            <div style="width: 20px; height: 20px; border: 2px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span>${files.length}ê°œ íŒŒì¼ ì—…ë¡œë“œ ë° ì²˜ë¦¬ ì¤‘...</span>
        </div>
    </div>
    <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
  `;

  const formData = new FormData();
  files.forEach(f => {
    formData.append("files", f, f.relativePath);
  });

  try {
    const res = await fetch("/files/upload-folder-raw", {
      method: "POST",
      body: formData
    });

    const data = await res.json();

    statusBox.innerHTML = `
      <div class="card" style="border-color: var(--success);">
          <h3 style="color: var(--success); margin-bottom: 12px;">âœ… ì—…ë¡œë“œ ì™„ë£Œ</h3>
          <p>ì´ ${data.files_count}ê°œ íŒŒì¼ì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
          <div class="file-list">
            ${data.files.map(f => `<div class="file-item">ğŸ“„ ${f}</div>`).join("")}
          </div>
      </div>
    `;

    // ğŸ”¥ iframe ë†’ì´ ì¬ê³„ì‚° íŠ¸ë¦¬ê±°
    window.dispatchEvent(new Event("resize"));

  } catch (err) {
    console.error(err);
    statusBox.innerHTML = `
        <div class="card" style="border-color: var(--error);">
            <h3 style="color: var(--error);">âŒ ì—…ë¡œë“œ ì‹¤íŒ¨</h3>
            <p>ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
        </div>
    `;
  }
});
</script>

<script>
async function loadLogs() {
  const res = await fetch("/api/logs?limit=300");
  const data = await res.json();

  const box = document.getElementById("logBox");
  box.innerHTML = data.logs.map(line => {
    let className = "log-entry";
    if (line.includes("[ERROR]")) className += " error";
    else if (line.includes("[INFO]")) className += " info";
    return `<div class="${className}">${line}</div>`;
  }).join("");

  // ğŸ”¥ ë¡œê·¸ ê°±ì‹  ì‹œ iframe ë†’ì´ ë°˜ì˜
  window.dispatchEvent(new Event("resize"));
}

setInterval(loadLogs, 2000);
loadLogs();
</script>
