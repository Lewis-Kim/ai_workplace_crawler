<div class="search-container">
    <div style="text-align: center; margin-bottom: 40px;">
        <h1>ğŸ” ì§€ëŠ¥í˜• ë¬¸ì„œ ê²€ìƒ‰</h1>
        <p style="color: var(--text-muted);">í‚¤ì›Œë“œ, ë¬¸ë§¥, í˜¹ì€ ìì—°ì–´ë¡œ ë¬¸ì„œ ë‚´ìš©ì„ ê²€ìƒ‰í•˜ì„¸ìš”.</p>
    </div>

    <!-- ê²€ìƒ‰ ì˜µì…˜ -->
    <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
        <select id="fileTypeFilter" style="padding: 8px 12px; min-width: 120px;">
            <option value="">ì „ì²´ íŒŒì¼</option>
            <option value="pdf">PDF</option>
            <option value="docx">DOCX</option>
            <option value="txt">TXT</option>
            <option value="xlsx">Excel</option>
            <option value="csv">CSV</option>
        </select>
        <select id="topKSelect" style="padding: 8px 12px; min-width: 100px;">
            <option value="5">5ê°œ</option>
            <option value="10">10ê°œ</option>
            <option value="20">20ê°œ</option>
        </select>
    </div>

    <div class="search-bar-wrapper">
        <input type="text" class="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í”„ë¡œì íŠ¸ ê¸°íšì•ˆ...)" id="searchInput">
        <button class="search-btn" onclick="performSearch()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </button>
    </div>

    <div id="searchResults">
        <div style="text-align: center; color: var(--text-muted); padding: 40px;">
            ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
        </div>
    </div>
</div>

<script>
async function performSearch() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return;

    const fileType = document.getElementById('fileTypeFilter').value;
    const topK = parseInt(document.getElementById('topKSelect').value);
    const resultsDiv = document.getElementById('searchResults');
    
    resultsDiv.innerHTML = `
        <div style="text-align:center; padding: 40px;">
            <div style="width: 24px; height: 24px; border: 2px solid var(--primary); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
            ê²€ìƒ‰ ì¤‘...
        </div>
        <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
    `;

    try {
        const requestBody = {
            query: query,
            top_k: topK
        };
        
        if (fileType) {
            requestBody.file_type = fileType;
        }

        const response = await fetch('/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        if (data.total === 0) {
            resultsDiv.innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-muted);">
                    <div style="font-size: 48px; margin-bottom: 16px;">ğŸ”</div>
                    <p>"${query}"ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <p style="font-size: 14px;">ë‹¤ë¥¸ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”.</p>
                </div>
            `;
        } else {
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin:0;">ê²€ìƒ‰ ê²°ê³¼: "${query}"</h3>
                    <span style="font-size: 12px; padding: 4px 12px; background: var(--bg-card); border-radius: 4px; border: 1px solid var(--border-color);">
                        ${data.total}ê±´ ë°œê²¬
                    </span>
                </div>
            `;

            for (const result of data.results) {
                const fileIcon = getFileIcon(result.file_type);
                const scorePercent = (result.score * 100).toFixed(1);
                const scoreColor = result.score >= 0.8 ? 'var(--success)' : result.score >= 0.6 ? 'var(--warning)' : 'var(--text-muted)';
                
                html += `
                    <div class="card" style="cursor: pointer;" onclick="toggleContent(this)">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <h4 style="color: var(--primary); margin: 0 0 8px; display: flex; align-items: center; gap: 8px;">
                                ${fileIcon} ${result.title || 'ì œëª© ì—†ìŒ'}
                            </h4>
                            <span style="font-size: 12px; color: ${scoreColor}; font-weight: 600;">${scorePercent}%</span>
                        </div>
                        <p style="font-size: 14px; color: var(--text-muted); line-height: 1.6; margin: 0;">
                            ${highlightQuery(result.content.substring(0, 200), query)}${result.content.length > 200 ? '...' : ''}
                        </p>
                        <div class="full-content" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color);">
                            <p style="font-size: 14px; color: var(--text-main); line-height: 1.8; white-space: pre-wrap;">${result.content}</p>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                            <span class="tag">Page ${result.page_no}</span>
                            <span class="tag">Chunk ${result.chunk_no}</span>
                            ${result.folder_name ? `<span class="tag">ğŸ“ ${result.folder_name}</span>` : ''}
                            <span class="tag">${result.file_type?.toUpperCase() || 'FILE'}</span>
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }
        
        window.dispatchEvent(new Event("resize"));

    } catch (error) {
        console.error('Search error:', error);
        resultsDiv.innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--error);">
                <div style="font-size: 48px; margin-bottom: 16px;">âš ï¸</div>
                <p>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                <p style="font-size: 14px; color: var(--text-muted);">${error.message}</p>
            </div>
        `;
    }
}

function getFileIcon(fileType) {
    const icons = {
        'pdf': 'ğŸ“•',
        'docx': 'ğŸ“˜',
        'doc': 'ğŸ“˜',
        'txt': 'ğŸ“„',
        'xlsx': 'ğŸ“Š',
        'xls': 'ğŸ“Š',
        'csv': 'ğŸ“Š',
        'jpg': 'ğŸ–¼ï¸',
        'jpeg': 'ğŸ–¼ï¸',
        'png': 'ğŸ–¼ï¸'
    };
    return icons[fileType?.toLowerCase()] || 'ğŸ“';
}

function highlightQuery(text, query) {
    if (!query) return text;
    const regex = new RegExp(`(${query})`, 'gi');
    return text.replace(regex, '<b style="color: var(--primary);">$1</b>');
}

function toggleContent(card) {
    const fullContent = card.querySelector('.full-content');
    if (fullContent) {
        fullContent.style.display = fullContent.style.display === 'none' ? 'block' : 'none';
        window.dispatchEvent(new Event("resize"));
    }
}

document.getElementById('searchInput').addEventListener('keypress', function (e) {
    if (e.key === 'Enter') {
        performSearch();
    }
});
</script>

<style>
.tag {
    font-size: 11px;
    padding: 2px 8px;
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary);
    border-radius: 4px;
}
</style>
